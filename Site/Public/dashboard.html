<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="/assets/icon/Pinguim_do_ep.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OwlFall | Usuario</title>

    <link rel="stylesheet" type="text/css" href="style/style.css">

    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="assets/icon/coruja.jpg">   

    <link rel="preconnect" href="https://fonts.gstatic.com"><link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

</head>

<body onload="obterDados()" >

    <div class="janela-dash">

        <div class="header-left">

            <h1>Usuário</h1>

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav"><a href="./personagens.html"><h3>Personagens</h3></a></div>
            <div class="btn-nav"><a href="./campanhas.html"><h3>Campanhas</h3></a></div>
            <div class="btn-nav"><a href="./poder.html"><h3>Poder</h3></a></div>
            <div class="btn-nav-white"><a href="Quiz.html"><h3>Quizes</h3></a></div>
            <div class="btn-nav-white"><a href="./dashboard.html"><h3>Dashboard</h3></a></div>
            <div class="btn-logout" onclick="limparSessao()"><h3>Sair</h3></div>

        </div>

        <div class="dash">

            <div class="kpi">
                <h3>Média de Acertos</h3>
                <span id="media_KPI">0%</span>
            </div>

            <div class="kpi">
                <h3>Personagem Mais Escolhido</h3>
                <div id="top1Personagem"></div>
            </div>

            <div class="kpi">
                <h3>Classe Mais Usada</h3>
                <div id="top1Classe"></div>
            </div>

            <div class="card-grafico">
                <h2>Gráfico de Acertos</h2>
                <div class="grafico-area">
                    <canvas id="linha"></canvas>
                </div>
            </div>

            <div class="card-grafico">
                <h2>Gráfico de Personagens</h2>
                <div class="grafico-area">
                    <canvas id="bar"></canvas>
                </div>
            </div>

            <div class="card-grafico">
                <h2>Gráfico de Classes</h2>
                <div class="grafico-area">
                    <canvas id="bar2"></canvas>
                </div>
            </div>


        </div>

    </div>

</body>
</html>

<script>
    var graficoLinha

    function obterDados() {
        fetch("/dashboard/medias")
            .then(function(r) { return r.json(); })
            .then(function(dados) {
                if(dados.length > 0){
                    AtualizarKpiMedia(dados);
                }
            });

        plotarGraficoLinha();

        fetch("/dashboard/classes")
            .then(function(r) { return r.json(); })
            .then(function(dados) {
                if(dados.length > 0){
                    plotarGraficoBarrasClasse(dados);
                    AtualizarKpiClasse(dados);
                }
            });

        fetch("/dashboard/personagens")
            .then(function(r) { return r.json(); })
            .then(function(dados) {
                if(dados.length > 0){
                    plotarGraficoBarrasPersonagem(dados);
                    AtualizarKpiPersonagem(dados);
                }
            });
    }
    
    
    function plotarGraficoLinha() {
        fetch("/dashboard/tentativas")
            .then(function(r) { return r.json(); })
            .then(function(dados) {
                var labels = [];
                var valores = [];
                
                for (var i = 0; i < dados.length; i++) {
                    labels.push("");
                    valores.push(Number(dados[i].pontuacao));
                }

                var ctx = document.getElementById('linha').getContext('2d');

                if (graficoLinha) {
                    graficoLinha.destroy();
                }

                graficoLinha = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Acertos por tentativa",
                            data: valores,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            });
    }

    function plotarGraficoBarrasClasse(dados) {
        var labels = [];
        var valores = [];
        for(var i = 0; i < dados.length; i++){
            labels.push(dados[i].classe);
            valores.push(Number(dados[i].quantidade));
        }

        var ctx = document.getElementById('bar').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: "Quantidade de usuários por classe", data: valores, backgroundColor: '#452816', borderColor: '#452816', borderWidth: 1 }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    function plotarGraficoBarrasPersonagem(dados) {
        var labels = [];
        var valores = [];
        for(var i=0; i<dados.length; i++){
            labels.push(dados[i].personagem);
            valores.push(Number(dados[i].quantidade));
        }

        var ctx = document.getElementById('bar2').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: "Quantidade de escolhas por personagem", data: valores, backgroundColor: [
                '#191970',
                '#228b22',
                '#daa520',
                '#b22222'
            ], borderColor: [
                '#191970',
                '#228b22',
                '#daa520',
                '#b22222'
            ], borderWidth: 1 }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    function AtualizarKpiMedia(dados){
        var totalQuestoes = 10;
        var media = Number(dados[0].media);
        var porcentagem = (media / totalQuestoes) * 100;
        document.getElementById('media_KPI').innerHTML = porcentagem.toFixed(0) + "%";
    }

    function AtualizarKpiPersonagem(dados){
        var div = document.getElementById('top1Personagem');
        var personagem = dados[0].personagem;
        div.innerHTML = "";

        var img = "";
        if(personagem == "Gon_Freecss") img = "assets/imgs/Gon.jpg";
        else if(personagem == "Killua_Zoldyck") img = "assets/imgs/Killua.jpg";
        else if(personagem == "Leorio") img = "assets/imgs/Leorio.jpg";
        else if(personagem == "Kurapika") img = "assets/imgs/Kurapika.jfif";

        div.innerHTML = '<img src="' + img + '" width="200">';
    }

    function AtualizarKpiClasse(dados){
        var div = document.getElementById('top1Classe');
        div.innerHTML = "<h2>" + dados[0].classe + "</h2>";
    }
</script>


